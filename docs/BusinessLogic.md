# 대기열을 DB로 구현하는 경우에서 콘서트 예약 서비스의 비즈니스 로직 예상 및 분석

대기열 시스템에 관해 인프런의 인강이나, Tech Blog 등 여러 레퍼런스들을 보면 대부분이 Redis를 사용한다. (웹소켓도 사용해서)  
하지만 이번 과제에서는 이 대기열 시스템을 레디스가 아닌 RDBMS만을 사용해서 기획부터 구현까지 직접 해보는 것이었다.

첫 번째로 든 생각은 자바에서 큐를 사용하는 것이었다.   
자바에서 선입선출(FIFO)로 큐를 구현해서 대기열 시스템을 구현해보자! 라고  생각을 했지만, 인스턴스가 여러개인 상황에서는 사용할 수 없는 방법이었다.

그래서 이번 주 발제를 자세히 읽어본 결과, 대기열 테이블이 존재해야 한다는 것을 알았다.

각 API의 비즈니스 로직을 예상하고 있어야 ERD를 짤 수 있을 것 같았다.  (엔터티를 뭘 써야 할지를 몰라서..)

## 비즈니스 로직 예상

### 유저 대기열 토큰 발급 API

1. POST요청(유저id)
2. 해당 유저id로 대기열 테이블을 조회해서 이미 대기열이 존재하는지 확인한다.
3. 존재하지 않다면 대기열 테이블에 insert.  (insert될 때는 상태가 waiting) return 201


여기에서 필요한 대기열 테이블의 칼럼이 (id(순번), 상태, 유저id)

### 예약 가능 날짜 조회 API
1. GET요청(유저id,콘서트id), Request Header에는 토큰.
2. 대기열 검증 프로세스 수행 (토큰으로 대기열 테이블 조회, 상태 칼럼 확인.) 상태 칼럼이 waiting이라면. 검증실패
3. 상태 칼럼이 pass라면, 검증성공, return (SELECT 날짜 FROM 콘서트_스케줄 테이블 where 콘서트id and 날짜<now)

이런 비즈니스 로직이 예상됨.

필요한 칼럼들은  콘서트(id), 콘서트 스케줄(id,콘서트id,날짜)

### 예약 가능 좌석 조회 API
1. GET요청(유저id,콘서트 스케줄 id,콘서트날짜) Request Header에는 토큰.
2. 대기열 검증 프로세스 수행 (토큰으로 대기열 테이블 조회, 상태 칼럼 확인.) 상태 칼럼이 waiting이라면. 검증실패
3. 상태 칼럼이 pass라면, 검증성공, return (SELECT 예약가능날짜 FROM 콘서트_좌석 테이블 WHERE 콘서트_스케줄_id and 좌석상태 = 빈좌석)

콘세트 좌석 테이블이 필요하다. (id, 콘서트스케줄id, 좌석상태,가격)
좌석 각각에 번호도 있어야 할것 같아서 좌석번호(1~50)도 넣자(이건 id값을 좌석번호로 쓰면 안된다.)

### 좌석 예약 요청 API
1. POST요청(유저id,콘서트 스케줄 id, 좌석id) Request Header에는 토큰.
2. 대기열 검증 프로세스 수행 (토큰으로 대기열 테이블 조회, 상태 칼럼 확인.) 상태 칼럼이 waiting이라면. 검증실패
3. 상태 칼럼이 pass라면, 검증성공, 좌석id로 좌석조회(여기에서 LOCK?을 해야할것 같다), 좌석상태가 빈상태면 좌석상태 update (좌석 선점됨)
4. 예약 테이블에 insert(id,콘서트id,콘서트스케줄id,좌석id,유저id,상태값(예약성공,결제성공,취소)), return 예약id

필요한 예약 테이블 칼럼(id,콘서트id,콘서트스케줄id,좌석id,유저id,상태값)
좌석의 예약은 5분간만 유효하다. 5분 안에 결제하지 않으면 취소됨.

### 잔액충전 API
1. PATCH요청(유저id, 충전금액) Request Header에는 토큰.
2. 대기열 검증 프로세스 수행, 검증 성공했다면,(발제에서는 검증을 해야한다고 되어있는데 이거 왜 검증해야하지?)
3. 유저id로 유저상세 테이블 조회, 잔액에 충전금액 더해서 update, return 200

필요한 유저상세 테이블(id,유저id,잔액)

### 잔액조회 API
1. GET요청(유저id), Request Header에는 토큰.
2. 대기열 검증 프로세스 수행, 검증 성공했다면,
3. 유저id로 유저상세 테이블의 “잔액” 조회 return

### 결제 API
1. POST 요청(유저id, 예약id) Request Header에는 토큰.
2. 대기열 검증 프로세스 수행
3. 검증 성공했다면, SELECT *from 예약 WHERE 예약id and status=예약성공
4. 조회한 예약의 created_at이 5분이 지났으면 예약정보 취소로 update 후  return (좌석예약은 5분후 만료됨)
5. 예약의 좌석id로 좌석의 가격 조회 (그냥 예약테이블에 가격 넣어도 될것 같다)
6. 유저id로 잔액 조회, 가격>잔액 -> Exception
7. 위 두 조건에서 통과한다면, 잔액차감, 예약정보 update(결제성공)
